<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropSpace V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        .nav-item { cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: all 0.3s; }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    </style>
</head>
<body class="flex flex-col items-center p-4">

    <nav class="glass-panel w-full max-w-4xl p-4 mb-8 flex justify-between items-center">
        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">DropSpace</h1>
        <div class="flex gap-2">
            <div onclick="showSection('home')" class="nav-item active" id="nav-home">Upload</div>
            <div onclick="showSection('dashboard')" class="nav-item hidden" id="nav-dash">My Cloud</div>
            <div onclick="showSection('auth')" class="nav-item" id="nav-auth">Login</div>
            <div onclick="doLogout()" class="nav-item hidden text-red-400" id="nav-logout">Logout</div>
        </div>
    </nav>

    <div class="w-full max-w-2xl">
        
        <div id="section-home" class="glass-panel p-8 text-center animate-fade">
            <h2 class="text-xl mb-6">Upload Files (Original Quality)</h2>
            
            <div id="dropZone" class="border-2 border-dashed border-gray-600 rounded-xl p-10 cursor-pointer hover:border-blue-500 transition">
                <i class="fas fa-cloud-upload-alt text-5xl text-blue-400 mb-4"></i>
                <p>Drag & Drop or Click</p>
                <input type="file" id="fileInput" class="hidden">
            </div>

            <div id="progressArea" class="hidden mt-6 text-left">
                <div class="flex justify-between mb-1 text-sm text-blue-400">
                    <span>Uploading...</span><span id="percentText">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div id="resultArea" class="hidden mt-6">
                <div class="bg-gray-800 p-3 rounded-lg flex items-center gap-2 border border-gray-600">
                    <input type="text" id="shareLink" readonly class="bg-transparent w-full text-sm outline-none text-gray-300">
                    <button onclick="copyLink()" class="text-blue-400"><i class="fas fa-copy"></i></button>
                </div>
                <button onclick="location.reload()" class="mt-4 text-sm text-gray-500">New Upload</button>
            </div>
        </div>

        <div id="section-auth" class="hidden glass-panel p-8 max-w-md mx-auto">
            <div id="login-form">
                <h2 class="text-xl font-bold mb-4">Login</h2>
                <input type="text" id="l-user" placeholder="Username" class="w-full p-3 bg-gray-800 rounded mb-3 border border-gray-600">
                <input type="password" id="l-pass" placeholder="Password" class="w-full p-3 bg-gray-800 rounded mb-4 border border-gray-600">
                <button onclick="login()" class="w-full bg-blue-600 py-2 rounded hover:bg-blue-700">Login</button>
                <p class="mt-4 text-sm text-gray-400 text-center">No account? <span onclick="toggleAuth('register')" class="text-blue-400 cursor-pointer">Register</span></p>
            </div>

            <div id="register-form" class="hidden">
                <h2 class="text-xl font-bold mb-4">Create Account</h2>
                <input type="text" id="r-user" placeholder="Username" class="w-full p-3 bg-gray-800 rounded mb-3 border border-gray-600">
                <input type="password" id="r-pass" placeholder="Password" class="w-full p-3 bg-gray-800 rounded mb-4 border border-gray-600">
                <button onclick="register()" class="w-full bg-green-600 py-2 rounded hover:bg-green-700">Register</button>
                <p class="mt-4 text-sm text-gray-400 text-center">Has account? <span onclick="toggleAuth('login')" class="text-blue-400 cursor-pointer">Login</span></p>
            </div>
        </div>

        <div id="section-dashboard" class="hidden glass-panel p-6">
            <h2 class="text-xl font-bold mb-4">My Cloud Storage</h2>
            <div id="fileList" class="space-y-3">
                <p class="text-gray-500 text-center">Loading files...</p>
            </div>
        </div>

    </div>

    <script>
        // --- Navigation Logic ---
        function showSection(id) {
            ['home', 'auth', 'dashboard'].forEach(s => document.getElementById('section-'+s).classList.add('hidden'));
            ['nav-home', 'nav-auth', 'nav-dash'].forEach(n => document.getElementById(n).classList.remove('active'));
            
            document.getElementById('section-'+id).classList.remove('hidden');
            if(id !== 'auth' && id !== 'dashboard') document.getElementById('nav-'+id).classList.add('active');
            
            if (id === 'dashboard') loadFiles();
        }

        function toggleAuth(type) {
            document.getElementById('login-form').classList.toggle('hidden', type === 'register');
            document.getElementById('register-form').classList.toggle('hidden', type === 'login');
        }

        // --- Auth State ---
        function checkLogin() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('username');
            if (token) {
                document.getElementById('nav-auth').classList.add('hidden');
                document.getElementById('nav-dash').classList.remove('hidden');
                document.getElementById('nav-dash').innerText = user + "'s Cloud";
                document.getElementById('nav-logout').classList.remove('hidden');
            } else {
                document.getElementById('nav-auth').classList.remove('hidden');
                document.getElementById('nav-dash').classList.add('hidden');
                document.getElementById('nav-logout').classList.add('hidden');
            }
        }
        checkLogin();

        // --- Helper: Send Form Data safely ---
        async function sendAuthData(url, username, password) {
            const params = new URLSearchParams();
            params.append('username', username);
            params.append('password', password);

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });
                const data = await res.json();
                return { ok: res.ok, data: data, status: res.status };
            } catch (e) {
                return { ok: false, data: { detail: "Connection Error" } };
            }
        }

        // --- API Calls ---

        async function register() {
            const user = document.getElementById('r-user').value;
            const pass = document.getElementById('r-pass').value;

            if (!user || !pass) { alert("Please fill in all fields"); return; }

            const result = await sendAuthData('/register', user, pass);
            
            if (result.ok) {
                alert('Account created! Logging you in...');
                // Auto Login after register
                document.getElementById('l-user').value = user;
                document.getElementById('l-pass').value = pass;
                login(); 
            } else {
                alert('Register Failed: ' + (result.data.error || result.data.detail || 'Unknown Error'));
            }
        }

        async function login() {
            const user = document.getElementById('l-user').value;
            const pass = document.getElementById('l-pass').value;

            if (!user || !pass) { alert("Please fill in all fields"); return; }

            // Endpoint is /token for OAuth2
            const result = await sendAuthData('/token', user, pass);
            
            if (result.ok) {
                localStorage.setItem('token', result.data.access_token);
                localStorage.setItem('username', result.data.username);
                checkLogin();
                showSection('home');
            } else {
                alert('Login Failed: ' + (result.data.detail || 'Check username/password'));
            }
        }

        function doLogout() {
            localStorage.clear();
            location.reload();
        }

        // --- Upload Logic ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.onclick = () => fileInput.click();
        
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-blue-500'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });

        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        function handleFile(file) {
            if (!file) return;
            document.getElementById('dropZone').classList.add('hidden');
            document.getElementById('progressArea').classList.remove('hidden');

            const formData = new FormData();
            formData.append("file", file);
            
            const token = localStorage.getItem('token');
            if (token) formData.append("token", token);

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/upload", true);
            
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const p = (e.loaded / e.total) * 100;
                    document.getElementById('progressBar').style.width = p + "%";
                    document.getElementById('percentText').innerText = Math.round(p) + "%";
                }
            };

            xhr.onload = () => {
                try {
                    const resp = JSON.parse(xhr.responseText);
                    if (xhr.status === 200) {
                        document.getElementById('progressArea').classList.add('hidden');
                        document.getElementById('resultArea').classList.remove('hidden');
                        document.getElementById('shareLink').value = window.location.origin + resp.download_url;
                    } else {
                        alert('Error: ' + (resp.error || resp.detail || 'Upload failed'));
                        location.reload();
                    }
                } catch (e) {
                    alert("Server Error. Check Logs.");
                    location.reload();
                }
            };
            xhr.send(formData);
        }

        // --- Dashboard Logic ---
        async function loadFiles() {
            const token = localStorage.getItem('token');
            const list = document.getElementById('fileList');
            list.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';

            try {
                const res = await fetch('/api/myfiles?token=' + token);
                if (res.status === 401 || res.status === 403) { doLogout(); return; }
                
                const files = await res.json();
                if (!Array.isArray(files) || files.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500">No files uploaded yet.</p>';
                    return;
                }

                let html = '';
                files.forEach(f => {
                    html += `
                        <div class="bg-gray-800 p-4 rounded flex justify-between items-center border border-gray-700 hover:border-blue-500">
                            <div class="overflow-hidden">
                                <p class="font-bold text-sm text-gray-200 truncate">${f.filename}</p>
                                <p class="text-xs text-gray-500">${f.size} â€¢ ${f.date}</p>
                            </div>
                            <div class="flex gap-3 shrink-0">
                                <a href="/dl/${f.uid}" target="_blank" class="text-blue-400 hover:text-white"><i class="fas fa-download"></i></a>
                                <button onclick="deleteFile('${f.uid}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            } catch (e) {
                list.innerHTML = '<p class="text-center text-red-500">Failed to load files.</p>';
            }
        }

        async function deleteFile(uid) {
            if (!confirm('Delete this file?')) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`/api/delete/${uid}?token=${token}`, { method: 'DELETE' });
            if (res.ok) loadFiles();
        }

        function copyLink() {
            const copyText = document.getElementById("shareLink");
            copyText.select();
            document.execCommand("copy");
            alert("Copied!");
        }
    </script>
</body>
</html>
